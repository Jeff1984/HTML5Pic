<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Image Editor</title>
</head>

<body onload="onInit()" style="margin:0px;" >

<div id="imgContainer" style="margin-top: 0px; text-align: center;">
    <canvas id="ImgFrameCanvas" width="722" height="482" style="z-index: 1; top:0px; left:0px; position:absolute"></canvas>
    <canvas id="ImageCanvas" width="722" height="482" style="z-index: 2; top:0px; left:0px; position:absolute"></canvas>
</div>
<div id="buttonContainer" style="margin-top: 490px; text-align: center;">
    <input type="button" id="SelectImage" value="SelectImage" onclick="openFile()"/>
    <input type="button" id="RotateLeft" value="RotateLeft" onclick="rotateImg('left')"/>
    <input type="button" id="RotateRight" value="RotateRight" onclick="rotateImg('right')"/>
    <input type="button" id="AddGem" value="AddGem"/>
    <input type="button" id="Save" value="Save" />
    <input type="button" id="OutPut" value="OutPut" />
</div>
<input type="file" name="file" id="file" style="display:none" onChange="realizeImgPath(this.id)" />

<script type="text/javascript">

    //frame
    var icf = document.getElementById("ImgFrameCanvas");
    var icf_cxt = icf.getContext("2d");
    //image
    var ic = document.getElementById("ImageCanvas");
    var ic_cxt = ic.getContext("2d");

    var decImgPath = "icon_02.png";
    var imagePath = "";
    var step = 0;
    var img = new Image();
    var GemImg = new Image();
    var gemX = 70;
    var gemY = 70;

    var mouseStartX,mouseStartY;
    var originGemX = 0;
    var originGemY = 0;

    function onInit()
    {
        document.getElementById("AddGem").addEventListener("click", addGem, false);
        document.getElementById("Save").addEventListener("click", save, false);
        document.getElementById("OutPut").addEventListener("click", outPut, false);

        //add border to the MainStage
        icf_cxt.fillStyle = "#FF0000";
        icf_cxt.moveTo(0,0);
        icf_cxt.lineTo(722,0);
        icf_cxt.lineTo(722,482);
        icf_cxt.lineTo(0,482);
        icf_cxt.lineTo(0,0);
        icf_cxt.stroke();
    }

    function openFile()
    {
        document.getElementById('file').click();
    }

    function realizeImgPath(sourceId)
    {
        if(typeof FileReader === "undefined")
        {
            alert("Your browser does not support FileReader.");
            return;
        }

        var reader = new FileReader();
        var file = document.getElementById(sourceId).files[0];

        reader.onload = function(e)
        {
            if(this.result.indexOf('data:image')==-1)
            {
                alert("The file type is not valid.");
                return;
            }
            imagePath = this.result;
            onOpenImage();
        };

        reader.readAsDataURL(file);
    }

    function onOpenImage()
    {
        step = 0;

        img = new Image();
        img.src = imagePath;
        img.addEventListener("load",drawImgWhenLoaded,false);

        GemImg = new Image();
        GemImg.src = "";
        gemX = 70;
        gemY = 70;

        function drawImgWhenLoaded()
        {
            var dx,dy,dw,dh;
            img.removeEventListener("load",drawImgWhenLoaded);
            setInterval("render()", 33);
        }
    }

    function rotateImg(direction)
    {
        var min_step = 0;
        var max_step = 3;

        if(direction == 'right')
        {
            step++;
            if(step > max_step)
                step = min_step;
        }
        else
        {
            step--;
            if(step < min_step)
                step = max_step;
        }
    }

    function addGem()
    {

        GemImg = new Image();
        GemImg.src = decImgPath;
        GemImg.addEventListener("load",drawGemWhenLoaded,false);

        function drawGemWhenLoaded()
        {
            GemImg.removeEventListener("load",drawGemWhenLoaded);
            GemImg.addEventListener("mousedown",onMouseDown,false);
        }
    }

    function onMouseDown(e)
    {
        mouseStartX = e.pageX;
        mouseStartY = e.pageY;
        originGemX = gemX;
        originGemY = gemY;
        GemImg.addEventListener("mousemove",onMouseMove,false);
        GemImg.addEventListener("mouseup",onMouseUp,false);
    }

    function onMouseMove(e)
    {
        var dhhScale = 482 / 722;

        if(img.width/img.height <= 1.49)
        {
            dhhScale =  img.height / img.width;
        }

        if(step == 1 || step == 3){
            gemX = originGemX + ( e.pageY - mouseStartY ) / dhhScale;
            gemY = originGemY + ( mouseStartX - e.pageX ) / dhhScale;
            if(GemX < 70)
                GemX = 70;
            if(GemX > 410)
                GemX = 410;
            if(gemY < 70)
                gemY = 70;
            if(gemY > 650)
                gemY = 650;
        }
        else{
            gemX = originGemX + e.pageX - mouseStartX;
            gemY = originGemY + e.pageY - mouseStartY;

            if(GemX < 70)
                GemX = 70;
            if(GemX > 650)
                GemX = 650;
            if(gemY < 70)
                gemY = 70;
            if(gemY > 410)
                gemY = 410;
        }
    }

    function onMouseUp(e)
    {
        continueRendering = false;
        GemImg.removeEventListener("mousemove",onMouseMove);
        GemImg.removeEventListener("mouseup",onMouseUp);
    }

    function save()
    {
        imagePath = ic.toDataURL("image/png");

        onOpenImage();
    }

    function outPut()
    {
        var image = ic.toDataURL("image/png").replace("image/png","image/octet-steam");
        window.location.href = image;
    }

    function clearImg()
    {
        ic_cxt.clearRect(0,0,ic.width,ic.height);
    }

    function render()
    {
        var dx,dy,dw,dh;
        var width = 722;
        var height = 482;
        var ddh = 50;
        var dhhScale = 482 / 722;

        clearImg();

        if(step == 1 || step == 3)
        {
            width = 482;
        }

        if(img.width/img.height > 1.49)
        {
            dw = width - 2;
            dh = img.height * width / img.width;
            ddh = ddh * width / img.width;
        }
        else
        {
            dh = height - 2;
            dw = img.width * height / img.height;
            ddh = ddh * height / img.height;
            dhhScale =  img.height / img.width;
        }

        if(step == 1 || step == 3)
        {
            height = 722;
        }

        dx = (width - dw) / 2;
        dy = (height - dh) / 2;

        if (step === 0) {
            ic.width = width;
            ic.height = height;
            ic_cxt.rotate(step * 90 * Math.PI / 180);
            ic_cxt.save();
            ic_cxt.drawImage(img, dx, dy, dw, dh);
            ic_cxt.drawImage(GemImg, dx + gemX, dy + gemY, ddh, ddh);
            ic_cxt.restore();
        } else if (step === 1) {
            ic.width = height;
            ic.height = width;
            ic_cxt.rotate(step * 90 * Math.PI / 180);
            ic_cxt.save();
            ic_cxt.drawImage(img, dx, dy - height, dw, dh);
            ic_cxt.drawImage(GemImg, dx + gemX * dhhScale, dy + gemY * dhhScale - height, ddh, ddh);
            ic_cxt.restore();
        } else if (step === 2) {
            ic.width = width;
            ic.height = height;
            ic_cxt.rotate(step * 90 * Math.PI / 180);
            ic_cxt.save();
            ic_cxt.drawImage(img, dx - width, dy - height, dw, dh);
            ic_cxt.drawImage(GemImg, dx + gemX - width, dy + gemY - height, ddh, ddh);
            ic_cxt.restore();
        } else if (step === 3) {
            ic.width = height;
            ic.height = width;
            ic_cxt.rotate(step * 90 * Math.PI / 180);
            ic_cxt.save();
            ic_cxt.drawImage(img, dx - width, dy, dw, dh);
            ic_cxt.drawImage(GemImg, dx + gemX * dhhScale - width, dy + gemY * dhhScale, ddh, ddh);
            ic_cxt.restore();
        }
    }

</script>
</body>
</html>