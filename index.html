<!DOCTYPE html>
 
<html>
 
<head>
    <div id="container" style="margin-top: 0px"/>
    <meta http-equiv="content-type" content="text/html" charset="utf-8"/>
    <img id="HH" src="1.png" style="display: none"/>
    <img id="TS" src="2.png" style="display: none"/>
    <img id="MM" src="3.png" style="display: none"/>
    <img id="TQS" src="4.png" style="display: none"/>
    <img id="AK" src="5.png" style="display: none"/>

    <img id="btns" src="btns.png" style="display:none;" />
    <title>Take or select photo(s) and upload</title>
    <form method="post" accept-charset="utf-8" name="form1">
        <input name="hidden_data" id='hidden_data' type="hidden"/>
    </form>
    <body onmousedown="return false;">
	<script src="quark.base-1.0.0.js"></script>
    <script src="editableImage.js"></script>
    <script type="text/javascript">
		//create a DOMContext
		var container; //= Quark.getDOM("container");

		var domContext; //= new Quark.DOMContext({canvas:container});
        var mousePos;
        var events;
        var selectedTarget;

        const MAX_HEIGHT=800;
        const MAX_WIDTH=600;
        //var selectFariyEvent =new CustomEvent("SELECT_A_FARIY");
        var stage;
        var canvas
        var editArr=[];

        var AnchorRota,AnchorScale;

        var startRtateX,startRotateY;
        window.addEventListener("load",eventWinLoaded,false);

		//or create a CanvasContext
        function eventWinLoaded(){

            //canvas.id="picture";
            container = Quark.getDOM("container");
            domContext = new Quark.DOMContext({canvas:container});

            //
            //var container = Quark.getDOM("container");
            canvas = Quark.createDOM("canvas", {width:600, height:800, style:
            {
                position:"absolute",
                backgroundColor:"#000"
            }});
            container.appendChild(canvas);
            var canvasContext = new Quark.CanvasContext({canvas:canvas});
            stage = new Quark.Stage({width:600, height:800,y:48,x:8,context:domContext, update:function()
            {
                //write your own update code here
            }});

            container.addEventListener('mousemove', function(evt) {
                mousePos = getMousePos(container, evt);
                repoAnchorToImage();
                var message = 'Mouse position: ' + mousePos.x + ',' + mousePos.y;
                //console.log( message);
            });

            var fps = 60;
            var timer = new Q.Timer(1000/fps);
            timer.addListener(stage);
            timer.start();

            var em = new Quark.EventManager();
            events= Quark.supportTouch ? ["touchstart", "touchmove", "touchend"] : ["mousedown", "mousemove", "mouseup"];
            em.registerStage(stage, events);

            //ADd
            for(var i=0;i<5;i++)
            {
                var im=new editableImage(getFairy(i),{id:"edit",x:0,y:0,autoSize:true});
                im.name=getFairy(i);
                stage.addChild(im);
                console.log("index is:",stage.getChildIndex(im));
                editArr.push(im);
                im.setWidth(200);
                im.setHeight(200);

                im.addEventListener("SELECT_A_FARIY",function (e)
                {
                    console.log("LOG::", e.detail.name);
                    selectedTarget=e.detail;
                    AnchorRota.visible=AnchorScale.visible=true;
                    repoAnchorToImage();
                    console.log("CHOOSED:",selectedTarget.name);
                    //selectedTarget.
                    for(im of editArr)
                    {
                        if(im.name!=e.detail.name)
                        {
                            im.setState(STATE.none);
                        }
                    }
                },false);
            }

            AnchorRota= new Q.Button({id:"btn2", image:Q.getDOM("btns"), regX:32,regY:32, width:64, height:64,
                up:{rect:[0,64,64,64]}});

            AnchorScale =new Q.Button({id:"btn1", image:Q.getDOM("btns"),x:32,y:32,regY:32, regX:32, width:64, height:64,
                up:{rect:[0,0,64,64]}});

            AnchorRota.addEventListener(events[0],startRotate,false);
            AnchorRota.addEventListener(events[2],stopScaleOrRotate,false);
            AnchorScale.addEventListener(events[0],startScale,false);
            AnchorScale.addEventListener(events[2],stopScaleOrRotate,false)

            stage.addChild(AnchorRota,AnchorScale);
            AnchorRota.visible=AnchorScale.visible=false;
        }

        function startRotate(e)
        {
            if (selectedTarget != null) {
                selectedTarget.setState(STATE.rotating);
                startRtateX=  AnchorRota.x = mousePos.x;
                startRtateY=  AnchorRota.y = mousePos.y;
            }
        }

        function stopScaleOrRotate(e)
        {
            selectedTarget.setState(STATE.none);
        }

        function startScale(e){
            if (selectedTarget != null) {
                selectedTarget.setState(STATE.scaling);
                AnchorScale.x = mousePos.x;
                AnchorScale.y = mousePos.y;
            }
        }

        function repoAnchorToImage() {
            var halfWidth,halfHeight,scaleNum,btMul=3;
            if (selectedTarget != null) {
                halfWidth=selectedTarget.getWidth()/btMul;
                halfHeight=selectedTarget.getHeight()/btMul;
                if(selectedTarget.getState()==STATE.scaling)
                {
                    scaleNum=Math.abs((mousePos.x- AnchorScale.x))>=Math.abs((mousePos.y- AnchorScale.y))?
                            (mousePos.y- AnchorScale.y)*btMul:(mousePos.x- AnchorScale.x)*btMul
                    selectedTarget.setWidth(selectedTarget.getWidth()+scaleNum);
                    selectedTarget.setHeight(selectedTarget.getHeight()+scaleNum);
                    AnchorScale.x = mousePos.x;
                    AnchorScale.y = mousePos.y;

                }else if(selectedTarget.getState()==STATE.rotating)
                {
                    //var dx=mousePos.x-selectedTarget.getWidth()-selectedTarget.x//-selectedTarget.getWidth();
                    //var dy=mousePos.y-selectedTarget.y;
                    var dx=mousePos.x-selectedTarget.x;
                    var dy=mousePos.y-selectedTarget.y;

                    //just for test
                    var r=Math.atan2(dy,dx)*180/Math.PI+45;

                    selectedTarget.rotation=r;
                    AnchorRota.x = mousePos.x;
                    AnchorRota.y = mousePos.y;
                    //console.log(mousePos.x,mousePos.y,selectedTarget.x,selectedTarget.y,"dd::",dy,dx,r,Math.tan(r));

                    //AnchorScale.x = selectedTarget.x + (selectedTarget.getWidth())*Math.cos(r/180*Math.PI);
                    //AnchorScale.y = selectedTarget.y + (selectedTarget.getHeight())*Math.sin(r/180*Math.PI);
                }else
                {
                    AnchorRota.x = selectedTarget.x + halfWidth;
                    AnchorRota.y = selectedTarget.y- halfHeight;//+selectedTarget.width;

                   AnchorScale.x = selectedTarget.x +halfWidth;
                   AnchorScale.y = selectedTarget.y +halfHeight;
                }

                //console.log(selectedTarget.getWidth(),AnchorRota.x);
            }
        }

        function getFairy(num){
            switch(num)
            {
                case 0:
                    return "HH";
                    break;
                case 1:
                    return "TS";
                    break;
                case 2:
                    return "MM";
                    break;
                case 3:
                    return "TQS";
                    break;
                case 4:
                    return "AK";
                    break;
            }
        }

        function getMousePos(canvas, evt) {
            var rect = canvas.getBoundingClientRect();
            return {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }

        //em.registerStage(stage,)

        /*
        * fairy
        * */
       function combinePic1(evt)
        {
            addFairy("HH");
        }
        function combinePic2(evt)
        {
            addFairy("TS");
        }
        function combinePic3(evt)
        {
            addFairy("MM");
        }
        function combinePic4(evt)
        {
            addFairy("TQS");
        }
        function combinePic5(evt)
        {
            addFairy("AK");
        }
        function addFairy(name)
        {
            var im=new editableImage(name,{id:"edit",x:0,y:0,autoSize:true});
            im.name=name;

            im.addEventListener("SELECT_A_FARIY",function (e)
            {
                console.log("LOG::", e.detail.name);
                selectedTarget=e.detail;
                console.log("CHOOSED:",selectedTarget.name);
                //selectedTarget.
                for(im of editArr)
                {
                    if(im.name!=e.detail.name)
                    {
                        im.setState(STATE.none);
                    }
                }
            },false);
            //im.dispatchEvent(selectFariyEvent);
            stage.addChild(im);
            editArr.push(im);
        }

        function setSelectImage(value)
        {
            if(selectedImage!=value)
            {
                selectedImage=value;
            }
        }


         //files related
        function fileSelected() {

            var count = document.getElementById('fileToUpload').files.length;

           // document.getElementById('details').innerHTML = "";

            for (var index = 0; index < count; index ++)

            {
                var file = document.getElementById('fileToUpload').files[index];
                this.loadFileToNewCanvas(file);
                /*var fileSize = 0;

                if (file.size > 1024 * 1024)

                    fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + 'MB';

                else

                    fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + 'KB';

                document.getElementById('details').innerHTML += 'Name: ' + file.name + '<br>Size: ' + fileSize + '<br>Type: ' + file.type;

                document.getElementById('details').innerHTML += '<p>';*/

            }
        }

        function loadFileToNewCanvas(file)
        {
            var ctx=canvas.getContext("2d");
            var img=new Image();
            img.src=window.URL.createObjectURL(file);
            img.onload=function(){
                ctx.clearRect(0,0,800,600);
                if(img.height>MAX_HEIGHT)
                {
                    img.height=MAX_HEIGHT;
                }
                if(img.width>MAX_WIDTH)
                {
                    img.width=MAX_WIDTH;
                }
                canvas.width=MAX_WIDTH;
                canvas.height=MAX_HEIGHT;
                ctx.drawImage(img,0,0,img.width,img.height);
            }
        }
 
    </script>
 
</head>
 
<body>
 
  <!--<form id="form1" enctype="multipart/form-data">-->
 
    <div>
        <label for="fileToUpload">Take or select photo(s)1.0.4</label>
        <div id="buttonContainer" style="margin-top: 1px; text-align: center;" >

            <input type="file" name="fileToUpload" id="fileToUpload" onchange="fileSelected();" accept="image/*" capture="camera"  style="margin-top: 0px"/>
            <input type="button" onclick="uploadFile()" value="Upload" />
            <input type="button" onclick="combinePic1()" value="花花" />
            <input type="button" onclick="combinePic2()" value="天使" />
            <input type="button" onclick="combinePic3()" value="喵喵" />
            <input type="button" onclick="combinePic4()" value="铁骑士" />
            <input type="button" onclick="combinePic5()" value="奥可" />

            <input type="button" onclick="copyCanvas()" value="CopyCanvas" />
        </div>
    </div>
 
    <div id="details"></div>
    <div id="progress"></div>
 <!-- </form>-->
 
</body>
 
</html>