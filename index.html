<!DOCTYPE html>
 
<html>
 
<head>
<meta http-equiv="content-type" content="text/html" charset="utf-8"/>
    <title>快来和精灵合影吧</title>
	<script src="quark.base-1.0.0.js"></script>
    <script src="exif.js"></script>
    <script src="binaryajax.js"></script>
    <script src="editableImage.js"></script>

    <!--<script type="text/javascript" src="WeixinApi.js"></script>
    <script>

        var lineLink    = 'http://10.0.55.212:5100/php/uploads/index.html';    // 要分享的页面的URL
        var imgUrl      = 'http://10.0.55.212:5100/php/icon.png';    // 显示在微信里的缩略图
        var shareTitle  = '页面标题';          // 页面标题
        var descContent = "页面内容简介";      // 内容简介
        var appid       = 'wx5db4ca8d702c0373';                  // APP ID, 可以为空
        var appsecret='574f7ad55b58f0ee204c0f6a524e37b6';


        function wx_shareFriend() {
            alert("share TO Friends");
            WeixinJSBridge.invoke('sendAppMessage',{
                "appid": appid,
                "img_url": imgUrl,
                //"img_width": "640",
                //"img_height": "640",
                "link": lineLink,
                "desc": descContent,
                "title": shareTitle
            }, function(res) {
                alert(res.err_msg);
            })
        }

        function wx_shareTimeline() {
            WeixinJSBridge.invoke('shareTimeline',{
                "img_url": imgUrl,
               // "img_width": "640",
               // "img_height": "640",
                "link": lineLink,
                "desc": descContent,
                "title": shareTitle
            }, function(res) {
                alert(res.err_msg);
            });
        }

        function wx_shareWeibo() {
            WeixinJSBridge.invoke('shareWeibo',{
                "content": descContent,
                "url": lineLink,
            }, function(res) {
                //alert(res.err_msg);
            });
        }

        function onBridgeReady(){
            WeixinJSBridge.on('menu:share:appmessage', wx_shareFriend);   // 发送给朋友
            WeixinJSBridge.on('menu:share:timeline',   wx_shareTimeline); // 分享到朋友圈
            WeixinJSBridge.on('menu:share:weibo',      wx_shareWeibo);    // 分享到微博

           // WeixinApi.hideOptionMenu();
        }

        if (typeof WeixinJSBridge == "undefined"){
            if( document.addEventListener ){
                document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
            }else if (document.attachEvent){
                document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
            }
        }else{
            onBridgeReady();
        }
        /*var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?91f4361e83cf34ffe3b6dd0471ee205a";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);

        })();

        window.wxData = {
            "appId": "wx5db4ca8d702c0373", // 服务号可以填写appId
            "imgUrl":'http://10.0.55.212:5100/php/icon.png',
            "link":'http://app9.download.anzhuoshangdian.com/cat/',
            "desc":"快来和精灵合影吧",
            "title":"快来和精灵合影吧"
        };
        window.wxFriend = {
            "appId": "wx5db4ca8d702c0373", // 服务号可以填写appId
            "imgUrl":'http://10.0.55.212:5100/php/icon.png',
            "link":'http://app9.download.anzhuoshangdian.com/cat/',
            "desc":'快来和精灵合影吧',
            "title":"快来和精灵合影吧"
        };
        WeixinApi.ready(function(Api) {
            var wxCallbacks = {
                ready : function() {
                },
                cancel : function(resp) {
                },
                fail : function(resp) {
                },
                confirm : function(resp) {
                    window.wxFriend="http://www.75team.com"
                },
                all : function(resp) {
                }
            };
            Api.shareToFriend(wxFriend, wxCallbacks);
            Api.shareToTimeline(wxData, wxCallbacks);
            Api.shareToWeibo(wxData, wxCallbacks);
        });*/
    </script>-->
    <script type="text/javascript">
		//create a DOMContext
		var container; //= Quark.getDOM("container");
        //alert("Notinit");
		var domContext; //= new Quark.DOMContext({canvas:container});
        var mousePos;
        var events;
        var selectedTarget;

        var ti;
        var imageLoaded=0;

        const MAX_HEIGHT=800;
        const MAX_WIDTH=600;
        const LAND="LANDSCAPE";
        const PORT="PORTRAIT";
        //var selectFariyEvent =new CustomEvent("SELECT_A_FARIY");
        var stage;
        var canvas,canvasCopy;
        var editArr=[];
        var testArr=[];
        var imageDics,selectedBgImage;
        var lastPt=null;
        var org;

        var AnchorRota,AnchorScale,selectedFile;

        const DEBUG=false,useDataToUrlModel=false,useExif=true;

        var startRtateX,startRotateY,dragOffsetX,dragOffsetY;
        //document.getElementById("parm").innerHTML="Notinit";
        window.onload = init;
        if(!useExif)
             window.onorientationchange=readDeviceOrientation;

		//or create a CanvasContext
        function readDeviceOrientation()
        {
            //console.log(Math.abs(window.orientation));
            if(Math.abs(window.orientation)===90)
            {
                org=LAND;
                document.getElementById("orientation").innerHTML="LAND";
            }else
            {
                org=PORT;
                document.getElementById("orientation").innerHTML="PORT";
            }
        }
        function init(){
            container = Q.getDOM("container");
            document.getElementById("buttonContainer").style.visibility="hidden";
            params = Quark.getUrlParams();
            if(params.mode == undefined) params.mode = 2;
            if(!DEBUG)  Q.getDOM("copyC").style.visibility="hidden";
            //document.getElementById("Copy").style.visibility="hidden";
            //document.getElementById("Upload").style.visibility="hidden";
            try {
                canvas= Q.getDOM("testC");

                if(!canvas||!canvas.getContext)
                {
                    showDebug("DONT SUPPORT CANVAS")
                }else
                {
                    showDebug("SUPPORT CANVAS")
                }

                //canvas.width=200;
               // canvas.height=200;

                var canvasContext = new Q.CanvasContext({canvas: canvas});

                domContext = new Quark.DOMContext({canvas: container});
            }catch (e)
            {
                alert(e);
            }

            stage = new Q.Stage({width:600, height:800,x:10,y:10,
                style: {
                    position: "absolute",
                },
                context:domContext, update:function()
            {
            }});

            var loader = new Quark.ImageLoader();
            loader.addEventListener("complete", onComplete);
            loader.load([{id:"HH", src:"1.png"}, {id:"TS", src:"2.png"},{id:"MM", src:"3.png"},{id:"TQS", src:"4.png"},{id:"AK", src:"5.png"},{id:"scale", src:"scale.png"},{id:"rotate", src:"rotate.png"}]);
            var fps = 60;
            var timer = new Q.Timer(1000/fps);
            timer.addListener(stage);
            timer.start();

            if(!useExif)
                ti=setInterval(readDeviceOrientation,1/20);

           var em = new Quark.EventManager();
           events= Quark.supportTouch ? ["touchstart", "touchmove", "touchend"] : ["mousedown", "mousemove", "mouseup"];
            em.registerStage(stage, events);
            //init listener
            container.addEventListener(events[1], draw, false);
            container.addEventListener(events[2], end, false);
        }

        function draw(e) {
            e.preventDefault();
            var rect = container.getBoundingClientRect();

            if(e.type == "mousemove")
            {
                mousePos={x: e.clientX- rect.left,y: e.clientY- rect.top};
            }
            else
            {
                mousePos = {x: e.touches[0].clientX- rect.left, y: e.touches[0].clientY- rect.top};
            }
            repoAnchorToImage();

        }

        function end(e) {
            e.preventDefault();
            // Terminate touch path
            mousePos=null;
            repoAnchorToImage();
        }

        function onComplete(e)
        {
            imageDics=e.images;
            var im,origChildId;
            for(var i=0;i<5;i++)
            {
                im=new editableImage(getFairy(i),{id:"edit",x:0,y:0,autoSize:true});
                im.name=getFairy(i);

                stage.addChild(im);
                //console.log("index is:",stage.getChildIndex(im));
                editArr.push(im);
                im.setWidth(200);
                im.setHeight(200);
                im.x=300;
                im.y=300;
                im.visible=false;

                im.addEventListener("SELECT_A_FARIY",function (e)
                {
                    //alert("LOGtarget::", e.detail.name);
                    origChildId=stage.getChildIndex(e.detail);
                    console.log("LOGID::", e.detail.name,origChildId);
                    stage.swapChildrenAt(origChildId,4);
                    selectedTarget=e.detail;
                    AnchorRota.visible=AnchorScale.visible=true;
                    repoAnchorToImage();
                    var i;
                    for(i=0;i<editArr.length;i++)
                    {
                        if(editArr[i].name!=e.detail.name)
                        {
                            editArr[i].setState(STATE.none);
                        }
                    }
                },false);
            }
            AnchorRota= new Q.Button({id:"btn2", image:e.images.rotate.image, regX:60,regY:60, width:120, height:120,
                up:{rect:[0,120,120,120]}});

            AnchorScale =new Q.Button({id:"btn1",image:e.images.scale.image,x:60,y:60,regY:60, regX:60, width:120, height:120,
                up:{rect:[0,0,120,120]}});

            AnchorRota.addEventListener(events[0],startRotate,false);
            AnchorRota.addEventListener(events[2],stopScaleOrRotate,false);
            AnchorScale.addEventListener(events[0],startScale,false);
            AnchorScale.addEventListener(events[2],stopScaleOrRotate,false)

            AnchorRota.scaleX=AnchorRota.scaleY=AnchorScale.scaleX=AnchorScale.scaleY=.7;
            stage.addChild(AnchorRota,AnchorScale);
            AnchorRota.visible=AnchorScale.visible=false;

            //alert("init complete");
            document.getElementById("buttonContainer").style.visibility="visible";
        }

        function startRotate(e)
        {
            if (selectedTarget != null) {
                selectedTarget.setState(STATE.rotating);
                startRtateX=  AnchorRota.x = mousePos.x;
                startRtateY=  AnchorRota.y = mousePos.y;
            }
        }

        function stopScaleOrRotate(e)
        {
            selectedTarget.setState(STATE.none);
        }

        function startScale(e)
        {
            if (selectedTarget != null)
            {
                selectedTarget.setState(STATE.scaling);
                AnchorScale.x = mousePos.x;
                AnchorScale.y = mousePos.y;
            }
        }

        function repoAnchorToImage() {
            var halfWidth,halfHeight,scaleNum,btMul=3;
            if (selectedTarget != null) {
                halfWidth=selectedTarget.getWidth()/btMul;
                halfHeight=selectedTarget.getHeight()/btMul;
                if(selectedTarget.getState()==STATE.scaling)
                {
                    scaleNum=Math.abs((mousePos.x- AnchorScale.x))>=Math.abs((mousePos.y- AnchorScale.y))?
                            (mousePos.y- AnchorScale.y)*btMul:(mousePos.x- AnchorScale.x)*btMul
                    selectedTarget.setWidth(selectedTarget.getWidth()+scaleNum);
                    selectedTarget.setHeight(selectedTarget.getHeight()+scaleNum);
                    AnchorScale.x = mousePos.x;
                    AnchorScale.y = mousePos.y;
                }else if(selectedTarget.getState()==STATE.rotating)
                {
                    var dx=mousePos.x-selectedTarget.x;
                    var dy=mousePos.y-selectedTarget.y;
                    //just for test
                    var r=Math.atan2(dy,dx)*180/Math.PI+45;

                    selectedTarget.rotation=r;
                    AnchorRota.x = mousePos.x;
                    AnchorRota.y = mousePos.y;

                }else
                {
                    AnchorRota.x = selectedTarget.x + halfWidth;
                    AnchorRota.y = selectedTarget.y- halfHeight;//+selectedTarget.width;

                   AnchorScale.x = selectedTarget.x +halfWidth;
                   AnchorScale.y = selectedTarget.y +halfHeight;
                }
            }
        }

        function getFairyByName(name)
        {
            switch(name)
            {
                case "HH":
                    return 0;
                    break;
                case "TS":
                    return 1;
                    break;
                case "MM":
                    return 2;
                    break;
                case "TQS":
                    return 3;
                    break;
                case "AK":
                    return 4;
                    break;
            }
        }

        function getFairy(num){
            switch(num)
            {
                case 0:
                    return "HH";
                    break;
                case 1:
                    return "TS";
                    break;
                case 2:
                    return "MM";
                    break;
                case 3:
                    return "TQS";
                    break;
                case 4:
                    return "AK";
                    break;
            }
        }

        /*******
        * fairy
        ********/
       function combinePic1(evt)
        {
            showFairy("HH");
        }
        function combinePic2(evt)
        {
            showFairy("TS");
        }
        function combinePic3(evt)
        {
            showFairy("MM");
        }
        function combinePic4(evt)
        {
            showFairy("TQS");
        }
        function combinePic5(evt)
        {
            showFairy("AK");
        }
        function showFairy(name)
        {
            if(selectedTarget)
            {
                selectedTarget.state=STATE.none;
            }
            var id=getFairyByName(name);
            origChildId=stage.getChildIndex(editArr[id]);
            stage.swapChildrenAt(origChildId,4);
            //AnchorRota.visible=
                    //AnchorScale.visible=
            editArr[id].visible=editArr[id].visible?false:true;

            if(editArr[id].visible==false)
            {
                AnchorRota.visible= AnchorScale.visible= false;
            }

        }

        function setSelectImage(value)
        {
            if(selectedImage!=value)
            {
                selectedImage=value;
            }
        }

        var imgRotation=-1;;
         //files related

        function fileSelected() {
           imgRotation=-1;
           var file = document.getElementById('fileToUpload').files[0];
            //test exif
            var fr = new FileReader();
            fr.readAsDataURL(file);
            fr.onload = function(fe){
                var result = this.result;
                var img = new Image();
                var exif;
                img.onload = function() {
                    var base64 = result.replace(/^.*?,/,'');
                    var binary = atob(base64);
                    var binaryData = new BinaryFile(binary);
                    exif = EXIF.readFromBinaryFile(binaryData);
                    //PixelYDimension//PixelXDimension
                    alert(String(exif.Orientation)+" "+String(exif.PixelYDimension)+" "+String(exif.PixelXDimension))
                    if(exif)
                    {
                        if(exif.Orientation==8||exif.Orientation==6)
                        {
                            alert("竖着放，兄弟");
                            imgRotation=90;
                        }else
                        {
                            alert("横着放，兄弟");
                            imgRotation=0;
                        }
                    }

                    loadFileToNewCanvas(file);
                    /*var orientation = exif ? exif.Orientation : 1;
                    // 判断拍照设备持有方向调整照片角度

                    switch(orientation) {
                        case 3:
                            imgRotation = 180;
                            break;
                        case 6:
                            imgRotation = 90;
                            break;
                        case 8:
                            imgRotation = 270;
                            break;
                        default :
                            imgRotation=0;
                            break;
                    }*/

                    //alert(imgRotation);
                };

                // 转换二进制数据

                img.src = result;
            };
            //

            if(!useExif)
                 window.clearInterval(ti);
        }

        //test
        function showResult(fr, label) {
            var markup, result, n, aByte, byteStr;

            markup = [];
            result = fr.result;
            for (n = 0; n < result.length; ++n) {
                aByte = result.charCodeAt(n);
                byteStr = aByte.toString(16);
                if (byteStr.length < 2) {
                    byteStr = "0" + byteStr;
                }
                markup.push(byteStr);
            }
            bodyAppend("p", label + " (" + result.length + "):");
            bodyAppend("pre", markup.join(" "));

            alert(markup);
        }

        function bodyAppend(tagName, innerHTML) {
            var elm;

            elm = document.createElement(tagName);
            elm.innerHTML = innerHTML;
            document.body.appendChild(elm);
        }
        //

        function copyEditedFairy()
        {
            var i,toAddedImage,tempImage,renderTimer;

            renderTimer=new Date().getMilliseconds();
            for(i=0;i<stage.getNumChildren();i++)
            {
                console.log(stage.getChildAt(i).name);
                toAddedImage=stage.getChildAt(i)
                if(toAddedImage.name==null||toAddedImage.visible==false)
                {
                    continue;
                }
                tempImage=imageDics[toAddedImage.name].image;
                copyTempImageToCopyCanvas(tempImage,toAddedImage.x,toAddedImage.y,toAddedImage.getWidth(),toAddedImage.getHeight(),toAddedImage.rotation);
            }

            renderTimer=new Date().getMilliseconds()-renderTimer;
            console.log("start coping...",renderTimer);
        }

        function copyTempImageToCopyCanvas(_tempImage,x,y,width,height,rot)
        {
            var ctx=Q.getDOM("copyC").getContext("2d");
            ctx.save();
            console.log("rot...",rot);
            //ctx.translate(x-Math.abs(Math.sin(rot*Math.PI/180)*width/2),y-Math.abs(Math.cos(rot*Math.PI/180)*height/2));
            ctx.translate(x,y);
            ctx.rotate(rot*Math.PI/180);
            //console.log(rot,rot*Math.PI/180);
            ctx.drawImage(_tempImage,-width/2,-height/2,width,height);
            ctx.restore();
        }
        var imageH,imageW;
        function addImageToCanvas(_targetCanvas,file)
        {
            var ctx=_targetCanvas.getContext("2d");
            //alert(_targetCanvas);
            var img=new Image();
            selectedFile=file;
            //QQ browser support it
            img.src=window.webkitURL.createObjectURL(file);

            console.log(_targetCanvas.width,_targetCanvas.height);
            img.onload=function(){
                ctx.clearRect(0,0,_targetCanvas.width,_targetCanvas.height);
                selectedBgImage=img;
                ctx.save();
               // exif.PixelYDimension
               // alert(String(selectedBgImage.width)+" "+String(selectedBgImage.height));
                if(!useExif) {
                    if (img.height > MAX_HEIGHT) {
                        imageH = MAX_HEIGHT;
                    } else {
                        imageH = img.height
                    }
                    if (img.width > MAX_WIDTH) {
                        imageW = MAX_WIDTH;
                    } else {
                        imageW = img.width
                    }

                    if(org==PORT){
                        img.width=imageH;
                        img.height=imageW;

                        ctx.translate(imageW,0);
                        ctx.rotate(Math.PI/2);

                        ctx.drawImage(img,0,0,imageH,imageW);
                    }else
                    {
                        img.width=imageW;
                        img.height=imageH;
                        ctx.drawImage(img,0,0,imageW,imageH);
                    }
                }else
                {
                    //TODO fix exif edition
                    if(imgRotation==90)
                    {
                        //width 600 height 800
                        imageW=600;
                        imageH=800;
                        stage.width=_targetCanvas.width=600;
                        stage.height=_targetCanvas.height=800;
                        /*if(imgRotation==270)
                        {
                            rotate=Math.PI;
                            ctx.rotate(rotate);
                        }*/
                        ctx.translate(imageW,0);
                        ctx.rotate(Math.PI/2);
                        ctx.drawImage(img,0,0,imageH,imageW);
                       // alert("说好的竖着放哪");

                    }else
                    {
                        //width 800 height 600
                        imageW=800;
                        imageH=600;
                        stage.width=_targetCanvas.width=800;
                        stage.height=_targetCanvas.height=600;

                        //ctx.translate(imageW,0);
                        //rotate=imgRotation==180?Math.PI/2:0-Math.PI/2
                        //        ctx.rotate(rotate);
                        ctx.drawImage(img,0,0,imageW,imageH);
                    }
                    //alert(imgRotation);
                    //console.log("ROTATE::",rotate,stage.y,_targetCanvas.y);

                }
                ctx.restore();
            }
        }

        function drawDataToCanvas(blob)
        {
            var ctx=canvas.getContext("2d");
            //alert(_targetCanvas);
            var img=new Image();
            //QQ browser support it
            img.src=window.webkitURL.createObjectURL(blob);

            img.onload=function(){
                ctx.clearRect(0,0,600,800);
                ctx.save();

                    img.width=600;
                    img.height=800;
                    ctx.drawImage(img,0,0,600,800);
                    ctx.drawImage(img,0,0,600,800);
                ctx.restore();
            }
        }

        function copyCanvas(evt)
        {
            if(selectedTarget)
            {
                selectedTarget.state=STATE.none;
            }
            //copy image pic to back, copy visible==true fairy to canvas and rotate it
            var copy= Q.getDOM("copyC");
            var ctx = copy.getContext("2d");
            if(ctx) {
                ctx.save();
                ctx.clearRect(0, 0, 600, 800);
            }
            if(selectedBgImage) {

                if(org==PORT){
                    selectedBgImage.width=imageH;
                    selectedBgImage.height=imageW;
                    ctx.translate(imageW,0);
                    ctx.rotate(Math.PI/2);
                    ctx.drawImage(selectedBgImage,0,0,imageH,imageW);
                }else
                {
                    selectedBgImage.width=imageW;
                    selectedBgImage.height=imageH;
                    ctx.drawImage(selectedBgImage,0,0,imageW,imageH);
                }

            }
            ctx.restore();
            copyEditedFairy();

        }

        function loadFileToNewCanvas(file)
        {
            addImageToCanvas(canvas,file);
        }

        function showDebug(Str)
        {
            document.getElementById("parm").innerHTML=Str;//mousePos.x+"::"+mousePos.y
        }

        /*
        1st check each fairy state
        */
        //TODO draw fairy to canvas and upload it
        var uploadResult;
        function dataURLtoBlob(dataURL) {
            var byteString;
            if (dataURL.split(',')[0].indexOf('base64') >= 0) {
                //byteString = atob(dataURL.split(',')[1]);
                byteString = dataURL.split(',')[1];
                //console.log(byteString)
            }
            else {
                //byteString = unescape(dataURL.split(',')[1]);
                byteString= dataURL.split(',')[1];
            }
            uploadResult=byteString;
            var mimeString=dataURL.split(',')[0].split(':')[1].split(';')[0];
            var ab=new ArrayBuffer(byteString.length);
            var ia=new Uint8Array(byteString.length);
            for(var i=0;i<byteString.length;i++){
                ia[i]=byteString.charCodeAt(i);
            }

            testArr=ia;
            var _blob;
            try{
                _blob=new Blob([ia],{type:mimeString});
            }catch(e)
            {
                window.BlobBuilder = window.BlobBuilder ||
                        window.WebKitBlobBuilder ||
                        window.MozBlobBuilder ||
                        window.MSBlobBuilder;
                if(e.name == 'TypeError' && window.BlobBuilder){

                    const TESTTXT=false;
                    var bb = new BlobBuilder();
                    if(TESTTXT){
                        bb.append("THIS is test");
                        _blob = bb.getBlob("text/plain");
                       // alert(_blob.type);
                    }else {

                        bb.append(ia.buffer);
                        _blob = bb.getBlob("image/png");
                        //just a test

                        drawDataToCanvas(_blob);
                    }
                }
                else if(e.name == "InvalidStateError"){
                    // InvalidStateError (tested on FF13 WinXP)
                    _blob = new Blob(ia, {type :mimeString});
                }
                else{
                    // We're screwed, blob constructor unsupported entirely
                }
            }
            return _blob;
        }

        function dataToBlob(data)
        {
            //alert(data);
            var ia=new Uint8Array(data.length);
            for(var i=0;i<data.length;i++){
                //console.log(data[i].length);
                ia[i]=data[i].charCodeAt(0);
            }
           // alert(ia.toString());
           // return new Blob([ia],{type:'image/jpeg'});
            var _blob;
            try{
                _blob=new Blob([ia],{type:"image/jpg"});
            }catch(e)
            {
                window.BlobBuilder = window.BlobBuilder ||
                        window.WebKitBlobBuilder ||
                        window.MozBlobBuilder ||
                        window.MSBlobBuilder;
                if(e.name == 'TypeError' && window.BlobBuilder){

                    const TESTTXT=true;
                    var bb = new BlobBuilder();
                    if(TESTTXT){
                        bb.append("THIS is test");
                        _blob = bb.getBlob("text/plain");
                        // alert(_blob.type);
                    }else {

                        bb.append(ia);
                        _blob = bb.getBlob("image/jpg");
                        //just a test

                        drawDataToCanvas(_blob);
                    }
                }
                else if(e.name == "InvalidStateError"){
                    // InvalidStateError (tested on FF13 WinXP)
                    _blob = new Blob(ia, {type :"image/jpeg"});
                }
                else{
                    // We're screwed, blob constructor unsupported entirely
                }
            }
            return _blob;
        }

        //released upload
        function copyAndUpload()
        {
            if(selectedTarget)
            {
                selectedTarget.state=STATE.none;
            }
            //copy image pic to back, copy visible==true fairy to canvas and rotate it
            var copy= Q.getDOM("copyC");
            var ctx = copy.getContext("2d");
            if(ctx) {
                ctx.save();
                ctx.clearRect(0, 0, 600, 800);
            }
            if(selectedBgImage) {
                if(org==PORT){
                    selectedBgImage.width=imageH;
                    selectedBgImage.height=imageW;
                    ctx.translate(imageW,0);
                    ctx.rotate(Math.PI/2);
                    ctx.drawImage(selectedBgImage,0,0,imageH,imageW);
                }else
                {
                    selectedBgImage.width=imageW;
                    selectedBgImage.height=imageH;
                    ctx.drawImage(selectedBgImage,0,0,imageW,imageH);
                }
            }
            ctx.restore();
            copyEditedFairy();
            uploadFile();
        }

        function uploadFile() {
            var canvas = document.getElementById("copyC");
            var dataURL = canvas.toDataURL("image/jpeg")//.replace("image/png");
            /*var blob;
            if (useDataToUrlModel) {
                var encoder = new JPEGEncoder();
                var data = encoder.encode(canvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height), 100);

                //var testImage = canvas.toDataURL("image/jpeg").replace("image/png", "image/octet-steam");
                blob=dataToBlob(data);
            } else {
                blob = dataURLtoBlob(dataURL);
            }

            var fd=new FormData(document.forms[1]);

            fd.append('myFile', blob);
            */

            var byteString=dataURL.split(',')[1];

            //===================================================
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "savetofile.php",true);
           // xhr.setRequestHeader('Content-Type',"image/jpeg")
            xhr.upload.addEventListener("progress", uploadProgress, false);

            xhr.addEventListener("load", uploadComplete, false);

            xhr.addEventListener("error", uploadFailed, false);

            xhr.addEventListener("abort", uploadCanceled, false);

            //xhr.open("POST", "savetofile.php",true);

           // xhr.send(fd);
            //xhr.send(fd);
            xhr.send(byteString);

        }

        function uploadProgress(evt) {

            if (evt.lengthComputable) {

                var percentComplete = Math.round(evt.loaded * 100 / evt.total);

                document.getElementById('orientation').innerHTML = percentComplete.toString() + '%';

                //alert(evt.loaded);

            }

            else {

                document.getElementById('orientation').innerHTML = 'unable to compute';

            }

        }

        function uploadComplete(evt) {

            /* This event is raised when the server send back a response */
            alert(evt.target.responseText);

            window.open("http://10.0.55.212:5100/php/uploads/",evt.target.responseText);

        }

        function uploadFailed(evt) {

            alert("There was an error attempting to upload the file.");

        }

        function uploadCanceled(evt) {

            alert("The upload has been canceled by the user or the browser dropped the connection.");

        }

        function backAndReset(evt)
        {

        }

        //editableImage======================================================================================================================================================================================================
        /**
         * Created by zhangchi on 2015/1/15.
         */
        //===================================================================================================================================================================================================================
       /* const STATE={
            editing:"editing",
            dragging:"dragging",
            scaling:"scaling",
            rotating:"rotating",
            none:"none"
        }
        var editableImage = function(name,props)
        {
            this.srcName=name;
            this._scaleX=1;
            this._scaleY=1;

            this._rotation=0;
            //self=this;
            editableImage.superClass.constructor.call(this, props);
            this.init();
        };
        Q.inherit(editableImage, Q.DisplayObjectContainer);

        editableImage.prototype.init=function()
        {
            this._image=new Q.Bitmap({id:"head", image:imageDics[this.srcName].image, x:0, y:0});
            this.eventChildren=false;
            this.addChild(this._image)
            this.addEventListener(events[0], this.startDrag,false);
            this.addEventListener(events[2], this.stopDrag,false);

            this._state=STATE.none;

            this._image.x=this.regX=this._image.regX=this._image.width>>1;
            this._image.y=this.regY=this._image.regY=this._image.height>>1;

        };

        editableImage.prototype.setEditable=function(value)
        {
            if(this._editable!=value)
            {
                this._editable=value;
            }
        };

        editableImage.prototype.setRotation=function (value)
        {
            this._rotation=value;
            this.rotation=value;
        }

        editableImage.prototype.setWidth=function(value)
        {
            this._scaleX=value/this._image.width;
            this.scaleX=this._scaleX
        }

        editableImage.prototype.getWidth=function()
        {
            return this._image.width*this._scaleX;
        }

        editableImage.prototype.setHeight=function(value)
        {
            this._scaleY=value/this._image.height;
            this.scaleY=this._scaleY;
        }

        editableImage.prototype.getHeight=function()
        {
            return this._image.height*this._scaleY;
        }

        editableImage.prototype.getState=function()
        {
            return this._state;
        }

        editableImage.prototype.setState = function(value)
        {
            if(this._state!=value)
            {
                this._state=value
            }
            switch(value)
            {
                case STATE.editing:
                case STATE.dragging:
                case STATE.rotation:
                case STATE.scaling:
                    this.setEditable(true);
                    break;
                case STATE.none:
                    this.setEditable(false);
                    break;
            }
        }

        editableImage.prototype.startDrag = function(e)
        {
            if(mousePos!=null)
            {
                dragOffsetX = mousePos.x - this.x;
                dragOffsetY = mousePos.y - this.y;
            }
            //TODO drag start here
            if (!this._state!=STATE.dragging)
            {
                this._state=STATE.dragging;
            }
            if (!this._editable)
            {
                this.setEditable(true);
            }
            //console.log("OFFSET::::", this.offsetX, this.offsetY);
            // }
            var selectFariyEvent =new CustomEvent("SELECT_A_FARIY",{'detail':this});
            this.dispatchEvent(selectFariyEvent,this);
        };

        editableImage.prototype.stopDrag = function(e)
        {
            e.preventDefault();
            if(this._state==STATE.dragging)
            {
                this._state=STATE.none;
            }
        };

        editableImage.prototype.update = function()
        {
            if(this._state==STATE.dragging&&mousePos!=null)
            {
                 this.x = mousePos.x //- dragOffsetX;
                 this.y = mousePos.y //-dragOffsetY;
            }
        }*/

    </script>
</head>
 
    <body>

        <div id="container">
            <canvas id="testC" width="600" height="800" style="background-color: rgb(0, 0, 0)"></canvas>
            <canvas id="copyC" width="600" height="800" style="background-color: rgb(0, 0, 0)"></canvas>
        </div>
        <img src="http://10.0.55.212:5100/php/icon.png" width="0" height="0"/>
        <div id="buttonContainer" style="top:810px; left:0px; position:absolute">
                <input type="button" onclick="combinePic1()" value="花花精灵" style="height:80px"/>
                <input type="button" onclick="combinePic2()" value="天使精灵"  style="height:80px"/>
                <input type="button" onclick="combinePic3()" value="喵喵精灵"  style="height:80px"/>
                <input type="button" onclick="combinePic4()" value="铁骑士精灵"  style="height:80px"/>
                <input type="button" onclick="combinePic5()" value="奥可精灵"  style="height:80px"/>
                <!--最终版返回按钮
                <input type="button" onclick="backAndReset()" value="返回编辑"  style="height:80px"/>-->
                <!--<input type="button" onclick="copyCanvas()" value="Copy"  style="height:80px"/>
                <input type="button" onclick="uploadFile()" value="Upload"  style="height:80px"/>-->
                <input type="button" onclick="copyAndUpload()" value="上传"  style="height:80px"/>
                <input type="file" name="fileToUpload" id="fileToUpload" onchange="fileSelected();" accept="image/*" capture="camera"/>
                <label id="parm">12222</label>
                <label id="orientation">no way</label>
                <label for="fileToUpload">1.0Take or select photo(s)1.0.11</label>
        </div>
        <form method="post" accept-charset="utf-8" name="form1">
            <input name="hidden_data" id='hidden_data' type="hidden"/>
        </form>

    </body>
 
</html>