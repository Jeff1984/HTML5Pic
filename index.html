<!DOCTYPE html>
 
<html>
 
<head>

<meta http-equiv="content-type" content="text/html" charset="utf-8"/>
<!-- id="HH" src="1.png" style="display:none"/>
<img id="TS" src="2.png" style="display:none"/>
<img id="MM" src="3.png" style="display:none"/>
<img id="TQS" src="4.png" style="display:none"/>
<img id="AK" src="5.png" style="display:none"/>

<img id="scale" src="scale.png" style="display:none;" />
<img id="rotate" src="rotate.png" style="display:none;" />-->
    <title>Take or select photo(s) and upload</title>
	<script src="quark.base-1.0.0.js"></script>
    <!--<script src="editableImage.js"></script>-->

    <script type="text/javascript">
		//create a DOMContext
		var container; //= Quark.getDOM("container");
        //alert("Notinit");
		var domContext; //= new Quark.DOMContext({canvas:container});
        var mousePos;
        var events;
        var selectedTarget;

        var imageLoaded=0;

        const MAX_HEIGHT=800;
        const MAX_WIDTH=600;
        //var selectFariyEvent =new CustomEvent("SELECT_A_FARIY");
        var stage;
        var canvas,canvasCopy;
        var editArr=[];
        var imageDics;
        var lastPt=null;

        var AnchorRota,AnchorScale,selectedFile;

        const DEBUG=true;

        var startRtateX,startRotateY;
        //document.getElementById("parm").innerHTML="Notinit";
        window.onload = init;

		//or create a CanvasContext

        function init(){

            //canvas.id="picture";
           // if(DEBUG)
                //alert("init");
            container = Q.getDOM("container");

            params = Quark.getUrlParams();
            if(params.mode == undefined) params.mode = 2;

            //if(params.mode == 1)
            //{
            try {
                canvas = Q.createDOM("canvas", {width: 600, height: 800,style: {
                    position: "absolute",
                    backgroundColor: "#000"
                }});

                container.appendChild(canvas);

               /* if(DEBUG) {
                    canvasCopy= Q.createDOM("canvas", {width: 600, height: 800,style: {
                        position: "absolute",
                        left:"615px",
                        backgroundColor: "#0ee"
                    }});
                    container.appendChild(canvasCopy);
                }*/

                var canvasContext = new Q.CanvasContext({canvas: canvas});

                ///}else
                //{
                domContext = new Quark.DOMContext({canvas: container});
                //alert(canvas);
            }catch (e)
            {
                alert(e);
            }
           // }
            document.getElementById("parm").innerHTML=params.mode;
            //
            stage = new Q.Stage({width:600, height:800,y:25,x:10,
                style: {
                    position: "absolute",
                },
                context:domContext, update:function()
            {
                //write your own update code here
                //document.getElementById("parm").innerHTML="for";

            }});

            //alert(stage.y);

            var loader = new Quark.ImageLoader();
            //loader.addEventListener("loaded", onLoad);
            loader.addEventListener("complete", onComplete);
            loader.load([{id:"HH", src:"1.png"}, {id:"TS", src:"2.png"},{id:"MM", src:"3.png"},{id:"TQS", src:"4.png"},{id:"AK", src:"5.png"},{id:"scale", src:"scale.png"},{id:"rotate", src:"rotate.png"}]);
            var fps = 60;
            var timer = new Q.Timer(1000/fps);
            timer.addListener(stage);
            timer.start();

           var em = new Quark.EventManager();
           events= Quark.supportTouch ? ["touchstart", "touchmove", "touchend"] : ["mousedown", "mousemove", "mouseup"];
            em.registerStage(stage, events);
            //init listener
            container.addEventListener(events[1], draw, false);
            container.addEventListener(events[2], end, false);

           /* container.addEventListener(events[1], function(evt) {
                mousePos = getMousePos(container, evt);
                repoAnchorToImage();
                var message = 'Mouse position: ' + mousePos.x + ',' + mousePos.y;
                //console.log( message);
            });*/
        }

        function draw(e) {
            e.preventDefault();
            var rect = container.getBoundingClientRect();

            if(e.type == "mousemove")
            {
                mousePos={x: e.clientX- rect.left,y: e.clientY- rect.top};
            }else
            {
                mousePos = {x: e.touches[0].clientX- rect.left, y: e.touches[0].clientY- rect.top};
            }
            document.getElementById("parm").innerHTML=mousePos.x+"::"+mousePos.y
           // console.log( mousePos.x,mousePos.y);
            repoAnchorToImage();

        }

        function end(e) {
            e.preventDefault();
            //alert("out");
            // Terminate touch path
           // mousePos=null;
            selectedTarget=null;
        }

        function onComplete(e)
        {
            imageDics=e.images;
            //alert(imageDics);
            //testDrag
            var testImage =e.images.HH.image;

            //test
           /* var bmp2 = new Quark.Bitmap({image:testImage, regX:32, regY:42});
            bmp2.x = 100;
            bmp2.y = 100;
            bmp2.scaleX = 2;
            bmp2.scaleY = 2;
            //stage.addChild(bmp2);
            bmp2.addEventListener(events[0], function(e)
            {
                bmp2.scaleX = bmp2.scaleY = bmp2.scaleX == 1? 2 : 1;
                //alert(e, e.type, e.eventX, e.eventY)
            });*/

            //alert("www");
            var im,origChildId;
            for(var i=0;i<5;i++)
            {

                im=new editableImage(getFairy(i),{id:"edit",x:0,y:0,autoSize:true});
                im.name=getFairy(i);
                //alert(im.name);

                stage.addChild(im);
                //console.log("index is:",stage.getChildIndex(im));
                editArr.push(im);
                im.setWidth(200);
                im.setHeight(200);

                im.x=300;
                im.y=300;
                //im.visible=false;

                im.addEventListener("SELECT_A_FARIY",function (e)
                {
                    //alert("LOGtarget::", e.detail.name);
                    origChildId=stage.getChildIndex(e.detail);
                    console.log("LOGID::", e.detail.name,origChildId);
                    stage.swapChildrenAt(origChildId,4);
                    selectedTarget=e.detail;
                    AnchorRota.visible=AnchorScale.visible=true;
                    repoAnchorToImage();
                    //selectedTarget.
                    var i;
                    for(i=0;i<editArr.length;i++)
                    {
                        if(editArr[i].name!=e.detail.name)
                        {
                            editArr[i].setState(STATE.none);
                        }
                    }
                },false);


            }
            AnchorRota= new Q.Button({id:"btn2", image:e.images.rotate.image, regX:32,regY:32, width:64, height:64,
                up:{rect:[0,64,64,64]}});

            AnchorScale =new Q.Button({id:"btn1",image:e.images.scale.image,x:32,y:32,regY:32, regX:32, width:64, height:64,
                up:{rect:[0,0,64,64]}});

            AnchorRota.addEventListener(events[0],startRotate,false);
            AnchorRota.addEventListener(events[2],stopScaleOrRotate,false);
            AnchorScale.addEventListener(events[0],startScale,false);
            AnchorScale.addEventListener(events[2],stopScaleOrRotate,false)

            stage.addChild(AnchorRota,AnchorScale);
            AnchorRota.visible=AnchorScale.visible=false;
        }


        function startRotate(e)
        {
            if (selectedTarget != null) {
                selectedTarget.setState(STATE.rotating);
                startRtateX=  AnchorRota.x = mousePos.x;
                startRtateY=  AnchorRota.y = mousePos.y;
            }
        }

        function stopScaleOrRotate(e)
        {
            selectedTarget.setState(STATE.none);
        }

        function startScale(e){
            if (selectedTarget != null) {
                selectedTarget.setState(STATE.scaling);
                AnchorScale.x = mousePos.x;
                AnchorScale.y = mousePos.y;
            }
        }

        function repoAnchorToImage() {
            var halfWidth,halfHeight,scaleNum,btMul=3;
            if (selectedTarget != null) {
                halfWidth=selectedTarget.getWidth()/btMul;
                halfHeight=selectedTarget.getHeight()/btMul;
                if(selectedTarget.getState()==STATE.scaling)
                {
                    scaleNum=Math.abs((mousePos.x- AnchorScale.x))>=Math.abs((mousePos.y- AnchorScale.y))?
                            (mousePos.y- AnchorScale.y)*btMul:(mousePos.x- AnchorScale.x)*btMul
                    selectedTarget.setWidth(selectedTarget.getWidth()+scaleNum);
                    selectedTarget.setHeight(selectedTarget.getHeight()+scaleNum);
                    AnchorScale.x = mousePos.x;
                    AnchorScale.y = mousePos.y;

                }else if(selectedTarget.getState()==STATE.rotating)
                {
                    //var dx=mousePos.x-selectedTarget.getWidth()-selectedTarget.x//-selectedTarget.getWidth();
                    //var dy=mousePos.y-selectedTarget.y;
                    var dx=mousePos.x-selectedTarget.x;
                    var dy=mousePos.y-selectedTarget.y;

                    //just for test
                    var r=Math.atan2(dy,dx)*180/Math.PI+45;

                    selectedTarget.rotation=r;
                    AnchorRota.x = mousePos.x;
                    AnchorRota.y = mousePos.y;
                    //console.log(mousePos.x,mousePos.y,selectedTarget.x,selectedTarget.y,"dd::",dy,dx,r,Math.tan(r));

                    //AnchorScale.x = selectedTarget.x + (selectedTarget.getWidth())*Math.cos(r/180*Math.PI);
                    //AnchorScale.y = selectedTarget.y + (selectedTarget.getHeight())*Math.sin(r/180*Math.PI);
                }else
                {
                    AnchorRota.x = selectedTarget.x + halfWidth;
                    AnchorRota.y = selectedTarget.y- halfHeight;//+selectedTarget.width;

                   AnchorScale.x = selectedTarget.x +halfWidth;
                   AnchorScale.y = selectedTarget.y +halfHeight;
                }

                //console.log(selectedTarget.getWidth(),AnchorRota.x);
            }
        }

        function getFairyByName(name)
        {
            switch(name)
            {
                case "HH":
                    return 0;
                    break;
                case "TS":
                    return 1;
                    break;
                case "MM":
                    return 2;
                    break;
                case "TQS":
                    return 3;
                    break;
                case "AK":
                    return 4;
                    break;
            }
        }

        function getFairy(num){
            switch(num)
            {
                case 0:
                    return "HH";
                    break;
                case 1:
                    return "TS";
                    break;
                case 2:
                    return "MM";
                    break;
                case 3:
                    return "TQS";
                    break;
                case 4:
                    return "AK";
                    break;
            }
        }

        /*******
        * fairy
        ********/
       function combinePic1(evt)
        {
            showFairy("HH");
        }
        function combinePic2(evt)
        {
            showFairy("TS");
        }
        function combinePic3(evt)
        {
            showFairy("MM");
        }
        function combinePic4(evt)
        {
            showFairy("TQS");
        }
        function combinePic5(evt)
        {
            showFairy("AK");
        }
        function showFairy(name)
        {
            var id=getFairyByName(name);
            origChildId=stage.getChildIndex(editArr[id]);
            stage.swapChildrenAt(origChildId,4);
            editArr[id].visible=true;
        }

        function setSelectImage(value)
        {
            if(selectedImage!=value)
            {
                selectedImage=value;
            }
        }

        function copyCanvas(evt)
        {
            //copy image pic to back, copy visible==true fairy to canvas and rotate it
            var ctx=canvasCopy.getContext("2d");
            var img=new Image();
            img.src=window.URL.createObjectURL(selectedFile);
            img.onload=function(){
                ctx.clearRect(0,0,800,600);
                if(img.height>MAX_HEIGHT)
                {
                    img.height=MAX_HEIGHT;
                }
                if(img.width>MAX_WIDTH)
                {
                    img.width=MAX_WIDTH;
                }
                canvasCopy.width=MAX_WIDTH;
                canvasCopy.height=MAX_HEIGHT;
                ctx.drawImage(img,0,0,img.width,img.height);
            }
        }

         //files related
        function fileSelected() {

            var count = document.getElementById('fileToUpload').files.length;

           // document.getElementById('details').innerHTML = "";

            for (var index = 0; index < count; index ++)

            {
                var file = document.getElementById('fileToUpload').files[index];
                loadFileToNewCanvas(file);
                /*var fileSize = 0;

                if (file.size > 1024 * 1024)

                    fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + 'MB';

                else

                    fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + 'KB';

                document.getElementById('details').innerHTML += 'Name: ' + file.name + '<br>Size: ' + fileSize + '<br>Type: ' + file.type;

                document.getElementById('details').innerHTML += '<p>';*/

            }
        }

        function loadFileToNewCanvas(file)
        {
            var ctx=canvas.getContext("2d");
            var img=new Image();
            selectedFile=file;
            img.src=window.URL.createObjectURL(file);
            img.onload=function(){
                ctx.clearRect(0,0,800,600);
                if(img.height>MAX_HEIGHT)
                {
                    img.height=MAX_HEIGHT;
                }
                if(img.width>MAX_WIDTH)
                {
                    img.width=MAX_WIDTH;
                }
                canvas.width=MAX_WIDTH;
                canvas.height=MAX_HEIGHT;
                ctx.drawImage(img,0,0,img.width,img.height);
            }
        }

    //editableImage
        /**
         * Created by zhangchi on 2015/1/15.
         */
        const STATE={
            editing:"editing",
            dragging:"dragging",
            scaling:"scaling",
            rotating:"rotating",
            none:"none"
        }
        var editableImage = function(name,props)
        {
            //alert("BEFORE");
            this.srcName=name;
            this._scaleX=1;
            this._scaleY=1;

            this._rotation=0;
            //self=this;
            editableImage.superClass.constructor.call(this, props);
            this.init();
        };
        Q.inherit(editableImage, Q.DisplayObjectContainer);

        editableImage.prototype.init=function()
        {
            this._image=new Q.Bitmap({id:"head", image:imageDics[this.srcName].image, x:0, y:0});
            //alert(events[0],this._image);
            //this.dragging=false;
            this.eventChildren=false;
            this.addChild(this._image)
            //gS.addEventListener(events[0],this.scaleImage);
            //gR.addEventListener(events[0],this.rotationImage);
            this.addEventListener(events[0], this.startDrag,false);
            this.addEventListener(events[2], this.stopDrag,false);

            //alert(events[0],this._image);

            //this.gS.visible=this.gR.visible=false;
            this._state=STATE.none;

            this._image.x=this.regX=this._image.regX=this._image.width>>1;
            this._image.y=this.regY=this._image.regY=this._image.height>>1;

        };

        editableImage.prototype.setEditable=function(value)
        {
            if(this._editable!=value)
            {
                this._editable=value;
            }
            // this.gS.visible=this.gR.visible=value;
        };

        editableImage.prototype.setRotation=function (value)
        {
            this._rotation=value;
            this.rotation=value;
        }

        editableImage.prototype.setWidth=function(value)
        {
            this._scaleX=value/this._image.width;
            this.scaleX=this._scaleX
        }

        editableImage.prototype.getWidth=function()
        {
            return this._image.width*this._scaleX;
        }

        editableImage.prototype.setHeight=function(value)
        {
            this._scaleY=value/this._image.height;
            this.scaleY=this._scaleY;
        }

        editableImage.prototype.getHeight=function()
        {
            return this._image.height*this._scaleY;
        }


        editableImage.prototype.getState=function()
        {
            return this._state;
        }

        editableImage.prototype.setState = function(value)
        {
            if(this._state!=value)
            {
                this._state=value
            }
            switch(value)
            {
                case STATE.editing:
                case STATE.dragging:
                case STATE.rotation:
                case STATE.scaling:
                    this.setEditable(true);
                    //this.gS.alpha=this.gR.alpha=1;
                    break;
                case STATE.none:
                    this.setEditable(false);
                    //this.gS.visible=this.gR.visible=false;
                    break;
            }
        }

        editableImage.prototype.scaleImage = function(){
            console.log("scaling");
            //self.scaleX-=0.1;
        }

        editableImage.prototype.rotationImage = function(){
            console.log("rotation");
            //this.rotation+=0.5;
            //self.scaleX-=0.1;
        }


        editableImage.prototype.startDrag = function(e)
        {
           // alert(this.x);
           // alert(mousePos.x);
            if(mousePos!=null) {
               // alert(mousePos.x);
                this.offsetX = mousePos.x - this.x;
                this.offsetY = mousePos.y - this.y;
            }
            // alert("CHOOSED:",this.x);
            //TODO drag start here
            //console.log("HIIITTT ROTATION::", Q.hitTestPoint(this.gR,mousePos.x,mousePos.y),"HIIITTT SCALING::",Q.hitTestPoint(this.gS,mousePos.x,mousePos.y));

            //this.eventChildren=false;
            if (!this._state!=STATE.dragging) {
                //this.dragging = true;
                this._state=STATE.dragging;
                // var test=this.getWidth();
                //this.setWidth(test+=10);
            }
            if (!this._editable) {
                this.setEditable(true);
            }
            console.log("OFFSET::::", this.offsetX, this.offsetY);
            // }
            var selectFariyEvent =new CustomEvent("SELECT_A_FARIY",{'detail':this});
            this.dispatchEvent(selectFariyEvent,this);
            //self.setState(STATE.editing);
        };

        editableImage.prototype.stopDrag = function(e)
        {
            e.preventDefault();
            //this.eventChildren=false;
            if(this._state==STATE.dragging)
            {
                this._state=STATE.none;
            }
            //this.visible=false;
            //alert("UP");
            // console.log("THIS IS:",self.x+(self.offsetX),self.y+(self.offsetY))
        };

        editableImage.prototype.update = function()
        {
            if(this._state==STATE.dragging&&mousePos!=null)
            {
                 this.x=mousePos.x-this.offsetX;
                 this.y=mousePos.y-this.offsetY;
            }

        }


    </script>
</head>
 
    <body>
        <!--<div id="details"></div>
        <div id="progress"></div>-->
        <div id="container"/>

        <div  style="z-index: 0">
                <!--<input type="button" onclick="uploadFile()" value="Upload" />-->
                <input type="button" onclick="combinePic1()" value="花花" />
                <input type="button" onclick="combinePic2()" value="天使" />
                <input type="button" onclick="combinePic3()" value="喵喵" />
                <input type="button" onclick="combinePic4()" value="铁骑士" />
                <input type="button" onclick="combinePic5()" value="奥可" />
                <input type="button" onclick="copyCanvas()" value="CopyCanvas" />
                <input type="file" name="fileToUpload" id="fileToUpload" onchange="fileSelected();" accept="image/*" capture="camera"/>
                 <label id="parm">12222</label>
                 <label for="fileToUpload">Take or select photo(s)1.0.10</label>
        </div>
     <!-- </form>-->

    </body>
 
</html>